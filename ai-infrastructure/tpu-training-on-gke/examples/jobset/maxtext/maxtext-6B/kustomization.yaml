# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: tpu-training



resources:
- ../base_maxtext

components:
- ../base_maxtext/components/replacements
images:
- name: maxtext-runner-image
  newName: us-docker.pkg.dev/jk-mlops-dev/jk2-training-images/maxtext-runner
  newTag: latest
- name: tb-uploader-image
  newName: us-docker.pkg.dev/jk-mlops-dev/jk2-training-images/tb-uploader
  newTag: latest
nameSuffix: "-101"
configMapGenerator:
- literals:
  - TPU_SLICE_TYPE=tpu-v4-podslice
  - TPU_TOPOLOGY=2x2x2
  - LOCAL_QUEUE=tpu-job-queue
  - ICI_PARALLELISM=8
  - JOB_PARALLELISM=2
  - NUM_SLICES=1
  - BASE_OUTPUT_DIRECTORY=gs://jk2-artifact-repository
  - RUN_NAME=single-slice-101
  - TENSORBOARD_NAME=projects/895222332033/locations/us-central1/tensorboards/9108042063194095616
  - DATASET_PATH=gs://jk2-artifact-repository/datasets
  - ARGS=steps=200 log_period=50 save_period=100 dcn_data_parallelism=2 ici_fsdp_parallelism=16
    per_device_batch_size=16 remat_policy=full base_emb_dim=4096 base_num_heads=16
    base_mlp_dim=16384 head_dim=256 base_num_decoder_layers=32
  - LIBTPU_INIT_ARGS=--xla_enable_async_all_gather=true TPU_MEGACORE=MEGACORE_DENSE
  name: maxtext-parameters
